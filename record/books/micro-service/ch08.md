# 08장 스프링 클라우드 소개

## 넷플릭스 유레카
- 검색 서비스

## 스프링 클라우드 게이트 웨이
- 에지 서버
- 사설 서비스를 외부에서 접근하지 못하도록 숨기고 외부 클라이언트가 공개 서비스를 사용할 때 보호
- URL 기반 라우팅, OAuth2.0, OIDC(OpenID Connect)에 기반한 엔드포인트 보호 기능 제공
- 스프링 5, 프로젝트 리액터, 스프링 부트 2 기반의 논블로킹 API 를 사용
  - 넷플릭스 주울 v1에 비해 더 많은 양의 동시 요청 처리 가능
  - 모든 외부 트래픽을 처리해야 하는 에지 서버에게는 중요한 특성

## 스프링 클라우드 컨피그
- 마이크로서비스 환경의 구성 정보를 중앙집중식으로 관리
- 다음과 같은 다양한 저장소에 구성 파일 저장 가능
  - 깃 저장소
  - 로컬 파일 시스템
  - 하시코프 볼트
  - JDBC 데이터베이스
- 계층 구조로 구성 관리 가능. 공통 구성 정보는 공통 파일에 배치하고, 특정 서비스를 위한 설정은 별도의 구성파일에 배치 가능.
- 구성 변경을 감지하며, 스프링 클라우드 버스를 사용해 영향받는 마이크로서비스로 알림을 보내는 기능도 지원.
- 스프링 클라우드 버스는 스프링 클라우드 스트림을 바탕으로 RabbitMQ 및 카프카 메시징 시스템을 사용해 알림을 전송한다.
- 자격 증명과 같은 민감한 구성 정보의 암호화도 지원

## Resilience4j
- 장애가 있는 게 당연하다고 간주하고, 장애를 처리할 수 있도록 시스템 환경을 설계
- 오픈 소스 기반 내결함성 라이브러리
- 다음과 같은 내결함성 매커니즘을 내장
  - 서킷 브레이커 : 원격 서비스가 응답하지 않을 경우에 발생하는 연쇄 장애를 방지 하고자 사용
  - 비율 제한기(rate limiter) : 지정한 시간 동안의 서비스 요청 수를 제한하고자 사용
  - 격벽(bulkhead) : 지정한 시간 동안의 서비스 요청 수를 제한하고자 사용
  - 재시도 : 때때로 발생하는 임의의 오류를 처리하고자 사용
  - 시간 초과(timeout) : 오랫동안 느리거나 응답이 없느 서비스의 응답을 기다리지 않고자 사용
- 스프링 부트 액추에이터의 health 엔드포인트를 사용해 마이크로서비스의 서킷 브레이커 상태를 모니터링할 수 있다.

## 스프링 클라우드 슬루스와 집킨을 사용한 분산 추적
- 마이크로서비스의 시스템 환경과 같은 분산 시스템에서 발생하는 상황을 파악하려면 시스템 환경에 대한 외부 호출을 처리하는 과정에서 마이크로서비스 사이를 오가는 요청 및 메시지의 흐름을 추적하고 시각화할 수 있어야 한다.
- 스프링 클라우드 슬루스는 상관 ID를 사용해 하나의 처리 흐름에 포함된 요청과 메시지/이벤트에 표시를 남긴다.
- 하나의 처리 흐름에서 나오는 여러 마이크로서비스의 로그 메시지를 쉽게 추적할 수 있도록 로그 메시지에 상관 ID를 덧붙인다.
- 스프링 클라우드 슬루스는 추적 데이터를 저장 및 시각화하고자 분산 추적 시스템인 집킨으로 보낸다.
- 스프링 클라우드 슬루스와 집킨이 분산 추적 정보를 처리하고자 사용하는 인프라는 구글 대퍼를 기반으로 한다.
- 대퍼에서는 전체 워크플로의 추적 정보를 추적 트리(trace tree)라고 하며, 기본 작업 단위와 같은 트리의 서브파트를 스팬(span)이라고 한다.
- 스팬은 추적 트리를 형성하는 하위 스팬으로 구성된다. 상관 ID를 TraceId라고 부르며, 소속된 추적 트리의 TraceId와 고유한 SpanId를 사용해 스팬을 식별한다.
- 스프링 클라우드 슬루스는 HTTP를 이용한 동기 요청이나 RabbitMQ 및 카프카를 사용한 비동기 요청을 집킨으로 보낸다.
- 마이크로 서비스에 집킨 서버에 대한 런타임 의존성을 추가하고 싶지 않다면 RabbitMQ나 카프카를 사용한 비동기 방식으로 추적 정보를 전송 하는 게 좋다.

## 출처
- 스프링으로 하는 마이크로서비스 구축 : 스프링 부트와 스프링 클라우드를 이용한 도커/쿠버네티스 마이크로서비스
  - 저자 : 매그너스 라슨
  - 역자 : 박규태
  - 출판사 : 에이콘출판사
